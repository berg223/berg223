name: Update Recent PRs
on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  fetch-prs:
    permissions: 
      contents: write  # ä»£ç æ¨é€æƒé™
      issues: read     # å…³é”®ï¼šæ·»åŠ PRè¯»å–æƒé™[1,7](@ref)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch PR data
        uses: actions/github-script@v7
        id: pr-data
        with:
          script: |
            // ä¿®å¤1: ç›´æ¥è·å–ç»“æœæ•°ç»„
            const results = await github.paginate(github.rest.search.issues, {
              q: `author:${{ github.repository_owner }} type:pr repo:apache/pulsar`,
              sort: 'updated',
              order: 'desc',
              per_page: 10
            });

            console.log(JSON.stringify(results))
            
            // ä¿®å¤2: ç›´æ¥æ“ä½œç»“æœæ•°ç»„
            return JSON.stringify(results.map(pr => ({
              title: pr.title.replace(/"/g, '\\"'),
              url: pr.html_url,
              repo: pr.repository_url.split('/').pop(),
              date: new Date(pr.created_at).toLocaleDateString('zh-CN')
            })));
          result-encoding: string

      - name: Update README
        run: |
          # ä¿®å¤3: å¤„ç†JSONæ ¼å¼è¾“å‡º
          echo '${{ steps.pr-data.outputs.result }}' > prs.json
          
          # ç”ŸæˆMarkdownåˆ—è¡¨
          echo "### ğŸš€ Recent PR on Apache Pulsar" > temp.md
          jq -r '.[] | "- [\(.title)](\(.url)) (\(.repo), \(.date))"' prs.json >> temp.md
          
          # æ›´æ–°READMEåŒºåŸŸ
          sed -i '/<!-- START_PR_LIST -->/,/<!-- END_PR_LIST -->/{//!d}' README.md
          sed -i '/<!-- START_PR_LIST -->/r temp.md' README.md
          
          # æäº¤æ›´æ”¹
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Update recent PR list"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
